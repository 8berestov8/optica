version: "3"
services:
  nginxProxy:
    image: 'jwilder/nginx-proxy'
    container_name: 'nginxProxy'
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./etc/nginx/certs:/etc/nginx/certs
      - ./etc/nginx/vhost.d:/etc/nginx/vhost.d
      - ./etc/nginx/conf.d/custom.conf:/etc/nginx/conf.d/custom.conf:ro
      - ./usr/share/nginx/html:/usr/share/nginx/html
      - /var/run/docker.sock:/tmp/docker.sock:ro
  nginxLetsencrypt:
    image: 'jrcs/letsencrypt-nginx-proxy-companion'
    container_name: 'nginxLetsencrypt'
    restart: always
    volumes_from:
      - nginxProxy
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./etc/acme.sh:/etc/acme.sh
    environment:
      - DEFAULT_EMAIL=letsencrypt@45.146.167.99
      - LETSENCRYPT_TEST=true
    depends_on:
      - nginxProxy
  strapi:
    platform: linux/amd64
    container_name: optika-api
    build: .
    image: arturvoll/sql_strapi:1.0.0
    restart: always
    env_file: .env
    environment:
      DATABASE_CLIENT: ${DATABASE_CLIENT}
      DATABASE_HOST: ${MYSQL_DATABASE_HOST}
      DATABASE_NAME: ${MYSQL_DATABASE}
      DATABASE_USERNAME: ${MYSQL_USER}
      DATABASE_PORT: ${MYSQL_DATABASE_PORT}
      JWT_SECRET: ${JWT_SECRET}
      DATABASE_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      NODE_ENV: ${NODE_ENV}
    links:
      - db:db
    volumes:
      - ./config:/opt/app/config
      - ./src:/opt/app/src
      - ./public:/opt/app/public
      - ./package.json:/opt/package.json
      - ./yarn.lock:/opt/yarn.lock
      - ./.env:/opt/app/.env
    ports:
      - "1337:1337"
    networks:
      - optika-strapi
    depends_on:
      - db
      #- nginxLetsencrypt
  db:
    image: mysql
    container_name: mysqlDB
    # NOTE: use of "mysql_native_password" is not recommended: https://dev.mysql.com/doc/refman/8.0/en/upgrading-from-previous-series.html#upgrade-caching-sha2-password
    # (this is just an example, not intended to be a production configuration)
    command: --default-authentication-plugin=mysql_native_password
    restart: always
    env_file: ".env"
    environment:
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      #depends_on:
      #- nginxLetsencrypt
    ports:
      - 3306:3306
    volumes:
      - ./data:/var/lib/mysql
    networks:
      - optika-strapi
  adminer:
    image: adminer
    container_name: adminer
    restart: always
    ports:
      - 8081:8080
    networks:
      - optika-strapi
#  mailserver:
#    image: docker.io/mailserver/docker-mailserver:latest
#    container_name: mailserver
#    # Provide the FQDN of your mail server here (Your DNS MX record should point to this value)
#    hostname: mail.example.com
#    ports:
#      - "25:25"
#      - "587:587"
#      - "993:993"
#    volumes:
#      - ./mailer/mail-data/:/var/mail/
#      - ./mailer/mail-state/:/var/mail-state/
#      - ./mailer/mail-logs/:/var/log/mail/
#      - ./mailer/config/:/tmp/docker-mailserver/
#      - ./etc/localtime:/etc/localtime:ro
#    environment:
#      - ENABLE_SPAMASSASSIN=1
#      - SPAMASSASSIN_SPAM_TO_INBOX=1
#      - ENABLE_CLAMAV=1
#      - ENABLE_FAIL2BAN=1
#      - ENABLE_POSTGREY=1
#    cap_add:
#      - NET_ADMIN # For Fail2Ban to work
#    restart: always
networks:
  optika-strapi:
    driver: bridge
